//@version=6
indicator("EMA-Volume", overlay=true)

len1 = input.int(50, "EMA1", minval=1)
len2 = input.int(200, "EMA2", minval=1)
//volLen = input.int(20, "Hacim MA Uzunluğu", minval=1)

// Ayar Parametreleri
src  = input.source(close, "Kaynak")
showEma1 = input.bool(true, "EMA1 göster")
showEma2 = input.bool(true, "EMA2 göster")
showVolume = input.bool(true, "Hacim analizini göster")
showVolumeMA = input.bool(true, "Hacim MA göster")

//showNotes = input.bool(true, "Notları göster")
customNote = input.string("Analiz Notu", "Özel not")

showLabels = input.bool(true, "Geçiş etiketlerini göster")

ema1 = ta.ema(src, len1) // 50
ema2 = ta.ema(src, len2) // 200

// Geçiş koşullarını global değişkenlere atayalım
bullishCross = ta.crossover(ema1, ema2)
bearishCross = ta.crossunder(ema1, ema2)

// Hacimli geçişler
// bullishCrossWithVolume = bullishCross and highVolume
// bearishCrossWithVolume = bearishCross and highVolume

plot(showEma1 ? ema1 : na, title="EMA1", color=color.orange, linewidth=2)
plot(showEma2 ? ema2 : na, title="EMA2", color=color.rgb(33, 243, 243),linewidth=2)

// Hacim hesaplamaları
scaleVolume = 100000

volumeUsd = volume*close 

volumeMA1 = ta.sma(volumeUsd/scaleVolume, 5) // purple
volumeMA2 = ta.sma(volumeUsd/scaleVolume, 30) // gri
highVolume = volume > volumeMA1 * 1.5 // volumeMa 20
lowVolume = volume < volumeMA1 * 0.7

var table volumeTable2 = table.new(position.bottom_left, 1,4, bgcolor=color.white, border_width=1)
table.cell(volumeTable2, 0, 0, "VolMa1-P-10", text_color=color.black, text_size=size.small)
table.cell(volumeTable2, 0, 1, "VolMa2-G-30", text_color=color.black, text_size=size.small)

// Hacim MA çizgisi (fiyat grafiğinin altında küçük bir çizgi olarak)
// plot(volumeUsd/scaleVolume, title="Vol-Usd", color=color.green, linewidth=1, style=plot.style_line) //, display=display.none
plot(volumeMA1, title="Vol-MA1", color=color.purple, linewidth=1, style=plot.style_line) //, display=display.none
plot(volumeMA2, title="Vol-Ma2", color=color.gray , linewidth=1, style=plot.style_line) //, display=display.none

// Hacim renk kodlaması
// volumeColor = highVolume ? color.red : lowVolume ? color.yellow : color.gray
//plotcandle(na, na, na, na, title="Hacim", color=color.gray, wickcolor=na, bordercolor=na, editable=false)

// İsterseniz geçişlerde arka plan rengi
bgcolor(bullishCross ? color.new(color.green, 85) : na)
bgcolor(bearishCross ? color.new(color.red, 85) : na)

// Yüksek hacimli geçişlerde daha belirgin arka plan
//bgcolor(bullishCrossWithVolume ? color.new(color.green, 70) : na)
//bgcolor(bearishCrossWithVolume ? color.new(color.red, 70) : na)

// Alternatif: plotchar ile ok işaretleri
plotchar(bullishCross, "Bullish", "▲", location.belowbar, color.green, size=size.small)
plotchar(bearishCross, "Bearish", "▼", location.abovebar, color.red, size=size.small)

// Yüksek hacimli geçişler için büyük işaretler
//plotchar(bullishCrossWithVolume, "Bullish Vol", "⬆", location.belowbar, color.lime, size=size.normal)
//plotchar(bearishCrossWithVolume, "Bearish Vol", "⬇", location.abovebar, color.maroon, size=size.normal)

// Hacim tablosu (isteğe bağlı)
if showVolume and barstate.islast
    var table volumeTable = table.new(position.top_right, 2, 4, bgcolor=color.white, border_width=1)
    table.cell(volumeTable, 0, 0, "Hacim Durumu", text_color=color.black, text_size=size.small)
    table.cell(volumeTable, 1, 0, volume > volumeMA1 ? "Yüksek" : "Normal", text_color=volume > volumeMA1 ? color.red : color.green, text_size=size.small)
    table.cell(volumeTable, 0, 1, "Hacim", text_color=color.black, text_size=size.small)
    table.cell(volumeTable, 1, 1, str.tostring(volume, "#"), text_color=color.black, text_size=size.small)
    table.cell(volumeTable, 0, 2, "Hacim MA", text_color=color.black, text_size=size.small)
    table.cell(volumeTable, 1, 2, str.tostring(volumeMA1, "#"), text_color=color.black, text_size=size.small)
    table.cell(volumeTable, 0, 3, "Oran", text_color=color.black, text_size=size.small)
    table.cell(volumeTable, 1, 3, str.tostring(volume/volumeMA1, "#.##"), text_color=color.black, text_size=size.small)

