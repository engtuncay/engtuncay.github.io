//@version=6
indicator("EMA-Volume-Momentum", overlay=true)

len1 = input.int(50, "EMA1", minval=1)
len2 = input.int(200, "EMA2", minval=1)
volLen = input.int(20, "Hacim MA Uzunluğu", minval=1)
volumeThreshold = input.float(1.5, "Yüksek Hacim Eşiği", minval=0.1, step=0.1)
volumeMomentumLength = input.int(14, "Hacim Momentum Uzunluğu", minval=1)
obvLength = input.int(20, "OBV EMA Uzunluğu", minval=1)

src  = input.source(close, "Kaynak")
showEma1 = input.bool(true, "EMA1 göster")
showEma2 = input.bool(true, "EMA2 göster")
showVolume = input.bool(true, "Hacim analizini göster")
showVolumeMA = input.bool(true, "Hacim MA göster")

showNotes = input.bool(true, "Notları göster")
customNote = input.string("Analiz Notu", "Özel not")

showLabels = input.bool(true, "Geçiş etiketlerini göster")

ema1 = ta.ema(src, len1) // 50
ema2 = ta.ema(src, len2) // 200

// Hacim hesaplamaları
scaleVolume = 100000
volumePlot = volume*close / scaleVolume

// Geçiş koşullarını global değişkenlere atayalım
bullishCross = ta.crossover(ema1, ema2)
bearishCross = ta.crossunder(ema1, ema2)

// Hacim hesaplamaları önce tanımlanmalı
volumeMA = ta.sma(volume*close/scaleVolume, 10) // purple
volumeMA2 = ta.sma(volume*close/scaleVolume, 50) // gri
volumeSMA = ta.sma(volume, volLen)
highVolume = volume > volumeSMA * volumeThreshold
lowVolume = volume < volumeSMA * 0.7

// Hacimli geçişler
bullishCrossWithVolume = bullishCross and highVolume
bearishCrossWithVolume = bearishCross and highVolume

// Hacim momentum - fiyat yönü ile hacim artışını karşılaştır
volumeMomentum = ta.rma(volume, volumeMomentumLength)
priceChange = close - close[1]
volumeChange = volume - volume[1]

// Hacim bazlı bullish/bearish sinyaller
volumeBullish = (priceChange > 0) and (volume > volumeMomentum * 1.2) and (close > ema1)
volumeBearish = (priceChange < 0) and (volume > volumeMomentum * 1.2) and (close < ema1)

// OBV (On Balance Volume) benzeri hesaplama
obv = ta.cum(close > close[1] ? volume : close < close[1] ? -volume : 0)
obvEma = ta.ema(obv, obvLength)
obvBullish = obv > obvEma and close > ema1
obvBearish = obv < obvEma and close < ema1

plot(showEma1 ? ema1 : na, title="EMA1", color=color.orange, linewidth=2)
plot(showEma2 ? ema2 : na, title="EMA2", color=color.rgb(33, 243, 243),linewidth=2)

// Hacim MA çizgisi (fiyat grafiğinin altında küçük bir çizgi olarak)
plot(showVolumeMA ? volumeMA : na, title="Vol-MA1", color=color.purple, linewidth=1, style=plot.style_line) //, display=display.none
plot(volumeMA2, title="Vol-Ma2", color=color.gray , linewidth=1, style=plot.style_line) //, display=display.none

// Hacim renk kodlaması
// volumeColor = highVolume ? color.red : lowVolume ? color.yellow : color.gray
//plotcandle(na, na, na, na, title="Hacim", color=color.gray, wickcolor=na, bordercolor=na, editable=false)

// İsterseniz geçişlerde arka plan rengi
bgcolor(bullishCross ? color.new(color.green, 85) : na)
bgcolor(bearishCross ? color.new(color.red, 85) : na)

// Yüksek hacimli geçişlerde daha belirgin arka plan
bgcolor(bullishCrossWithVolume ? color.new(color.green, 70) : na)
bgcolor(bearishCrossWithVolume ? color.new(color.red, 70) : na)

// Hacim bazlı sinyaller için arka plan
bgcolor(volumeBullish ? color.new(color.lime, 90) : na)
bgcolor(volumeBearish ? color.new(color.orange, 90) : na)

// Alternatif: plotchar ile ok işaretleri
plotchar(bullishCross, "Bullish", "▲", location.belowbar, color.green, size=size.small)
plotchar(bearishCross, "Bearish", "▼", location.abovebar, color.red, size=size.small)

// Yüksek hacimli geçişler için büyük işaretler
plotchar(bullishCrossWithVolume, "Bullish Vol", "⬆", location.belowbar, color.lime, size=size.normal)
plotchar(bearishCrossWithVolume, "Bearish Vol", "⬇", location.abovebar, color.maroon, size=size.normal)

// Hacim momentum sinyalleri
plotchar(volumeBullish, "Vol Bull", "●", location.belowbar, color.new(color.green, 0), size=size.tiny)
plotchar(volumeBearish, "Vol Bear", "●", location.abovebar, color.new(color.red, 0), size=size.tiny)

// OBV sinyalleri
plotshape(obvBullish, "OBV Bull", shape.triangleup, location.belowbar, color.blue, size=size.small)
plotshape(obvBearish, "OBV Bear", shape.triangledown, location.abovebar, color.purple, size=size.small)

// Güçlü sinyal kombinasyonu
strongBullish = bullishCrossWithVolume or (volumeBullish and obvBullish)
strongBearish = bearishCrossWithVolume or (volumeBearish and obvBearish)

// Alert koşulları
alertcondition(strongBullish, title="Güçlü Bullish Sinyal", message="Hacim destekli bullish sinyal!")
alertcondition(strongBearish, title="Güçlü Bearish Sinyal", message="Hacim destekli bearish sinyal!")
alertcondition(bullishCrossWithVolume, title="EMA Bullish + Yüksek Hacim", message="EMA geçişi yüksek hacimle birlikte!")
alertcondition(bearishCrossWithVolume, title="EMA Bearish + Yüksek Hacim", message="EMA geçişi yüksek hacimle birlikte!")

// Hacim tablosu (isteğe bağlı)
if showVolume and barstate.islast
    var table volumeTable = table.new(position.top_right, 2, 4, bgcolor=color.white, border_width=1)
    table.cell(volumeTable, 0, 0, "Hacim Durumu", text_color=color.black, text_size=size.small)
    table.cell(volumeTable, 1, 0, volume > volumeMA ? "Yüksek" : "Normal", text_color=volume > volumeMA ? color.red : color.green, text_size=size.small)
    table.cell(volumeTable, 0, 1, "Hacim", text_color=color.black, text_size=size.small)
    table.cell(volumeTable, 1, 1, str.tostring(volume, "#"), text_color=color.black, text_size=size.small)
    table.cell(volumeTable, 0, 2, "Hacim MA", text_color=color.black, text_size=size.small)
    table.cell(volumeTable, 1, 2, str.tostring(volumeMA, "#"), text_color=color.black, text_size=size.small)
    table.cell(volumeTable, 0, 3, "Oran", text_color=color.black, text_size=size.small)
    table.cell(volumeTable, 1, 3, str.tostring(volume/volumeMA, "#.##"), text_color=color.black, text_size=size.small)

// Hacim sinyal tablosu
if showVolume and barstate.islast
    var table signalTable = table.new(position.bottom_left, 2, 6, bgcolor=color.white, border_width=1)
    table.cell(signalTable, 0, 0, "Sinyal Tipi", text_color=color.black, text_size=size.small, bgcolor=color.gray)
    table.cell(signalTable, 1, 0, "Durum", text_color=color.black, text_size=size.small, bgcolor=color.gray)
    table.cell(signalTable, 0, 1, "Vol Bullish", text_color=color.black, text_size=size.small)
    table.cell(signalTable, 1, 1, volumeBullish ? "✓" : "✗", text_color=volumeBullish ? color.green : color.red, text_size=size.small)
    table.cell(signalTable, 0, 2, "Vol Bearish", text_color=color.black, text_size=size.small)
    table.cell(signalTable, 1, 2, volumeBearish ? "✓" : "✗", text_color=volumeBearish ? color.red : color.green, text_size=size.small)
    table.cell(signalTable, 0, 3, "OBV Bull", text_color=color.black, text_size=size.small)
    table.cell(signalTable, 1, 3, obvBullish ? "✓" : "✗", text_color=obvBullish ? color.blue : color.gray, text_size=size.small)
    table.cell(signalTable, 0, 4, "OBV Bear", text_color=color.black, text_size=size.small)
    table.cell(signalTable, 1, 4, obvBearish ? "✓" : "✗", text_color=obvBearish ? color.purple : color.gray, text_size=size.small)
    table.cell(signalTable, 0, 5, "Yüksek Hacim", text_color=color.black, text_size=size.small)
    table.cell(signalTable, 1, 5, highVolume ? "✓" : "✗", text_color=highVolume ? color.orange : color.gray, text_size=size.small)